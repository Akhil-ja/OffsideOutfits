<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Offside Outfits</title>
    <meta name="keywords" content="HTML5 Template">
    <meta name="description" content="Molla - Bootstrap eCommerce Template">
    <meta name="author" content="p-themes">
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href=" /productAssets/User-icon.svg">
    <!-- Plugins CSS File -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <!-- Main CSS File -->
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/plugins/owl-carousel/owl.carousel.css">
    <link rel="stylesheet" href="assets/css/plugins/magnific-popup/magnific-popup.css">
    <link rel="stylesheet" href="assets/css/plugins/nouislider/nouislider.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
</head>

<body>
    <div class="page-wrapper">
        <header class="header ">
            <div class="header-middle">
                <div class="header-top">
                    <div class="container-fluid">
                        <div class="header-left m-4">

                        </div><!-- End .header-left -->

                        <div class="header-right">
                            <ul class="top-menu">
                                <li>
                                    <a href="#">Links</a>
                                    <ul>
                                        <li><a href="tel:#"><i class="icon-phone"></i>Call: +0123 456 789</a></li>
                                        <li><a href="about.html">About Us</a></li>
                                        <li><a href="contact.html">Contact Us</a></li>
                                        <li style="display: none;"><a href="" data-toggle="modal"><i
                                                    class="icon-user"></i>Login</a>
                                        </li>
                                    </ul>
                                </li>
                            </ul><!-- End .top-menu -->
                        </div><!-- End .header-right -->
                    </div><!-- End .container-fluid -->
                </div><!-- End .header-top -->

                <div class="header-middle ">
                    <div class="container-fluid">
                        <div class="header-left">


                            <a href="/home" class="logo">
                                <img src="assets/images/Logo1.png" alt="Molla Logo" width="50" height="25">
                            </a>

                            <nav class="main-nav">
                                <ul class="menu sf-arrows">
                                    <li class="megamenu-container ">
                                        <a href="/home" class="">Home</a>
                                    </li>
                                    <li class="">
                                        <a href="/products" class=" ">Shop</a>


                                    </li>
                                    <li>
                                        <a href="" class="">Product</a>
                                    </li>
                                    <li>
                                        <a href="#" class="">Pages</a>
                                    </li>
                                    <li>
                                        <a href="" class="">Blog</a>
                                    </li>
                                    <li>
                                        <a href="" class="">Elements</a>


                                    </li>
                                </ul><!-- End .menu -->
                            </nav><!-- End .main-nav -->
                        </div><!-- End .header-left -->

                        <div class="header-right">

                            <div class="header-search">
                                <a href="#" class="search-toggle" role="button"><i class="icon-search"></i></a>
                                <form action="#" method="get">
                                    <div class="header-search-wrapper">
                                        <label for="q" class="sr-only">Search</label>
                                        <input type="search" class="form-control" name="q" id="q"
                                            placeholder="Search in..." required>
                                    </div><!-- End .header-search-wrapper -->
                                </form>
                            </div><!-- End .header-search -->

                            <a href="" class="wishlist-link">
                                <i class="icon-heart-o"></i>
                            </a>

                            <div class=" cart-dropdown">
                                <a href="/cart" class="dropdown-toggle" role="button" aria-haspopup="true"
                                    aria-expanded="false" data-display="static">
                                    <i class="icon-shopping-cart"></i>
                                </a>
                            </div>

                            <div class=" cart-dropdown">
                                <a href="/profile" class="dropdown-toggle" role="button" aria-haspopup="true"
                                    aria-expanded="false" data-display="static">
                                    <i class="icon-user"></i>

                                </a>
                            </div>

                        </div><!-- End .header-right -->
                    </div><!-- End .container-fluid -->
                </div><!-- End .header-middle -->
            </div>
        </header><!-- End .header -->

        <main class="main">
            <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
                <div class="container">
                    <h1 class="page-title">My Account<span></span></h1>
                </div><!-- End .container -->
            </div><!-- End .page-header -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">

            </nav><!-- End .breadcrumb-nav -->
            <div class="page-content">
                <div class="dashboard">
                    <div class="container">
                        <div class="row">
                            <aside class="col-md-4 col-lg-3">
                                <ul class="nav nav-dashboard flex-column mb-3 mb-md-0" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="tab-dashboard-link" data-toggle="tab"
                                            href="#tab-dashboard" role="tab" aria-controls="tab-dashboard"
                                            aria-selected="true">Dashboard</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="tab-orders-link" data-toggle="tab" href="#tab-orders"
                                            role="tab" aria-controls="tab-orders" aria-selected="false">Orders</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="tab-downloads-link" data-toggle="tab"
                                            href="#tab-downloads" role="tab" aria-controls="tab-downloads"
                                            aria-selected="false">Downloads</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="tab-address-link" data-toggle="tab" href="#tab-address"
                                            role="tab" aria-controls="tab-address" aria-selected="false">Adresses</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="tab-account-link" data-toggle="tab" href="#tab-account"
                                            role="tab" aria-controls="tab-account" aria-selected="false">Change
                                            Password</a>
                                    </li>
                                    <li class="nav-item">
                                        <a style="color: red;" class="nav-link font-weight-bold" href="/logout">Sign
                                            Out</a>
                                    </li>
                                </ul>
                            </aside>

                            <div class="col-md-8 col-lg-9">
                                <div class="tab-content">

                                    <div class="tab-pane fade show active" id="tab-dashboard" role="tabpanel" aria-labelledby="tab-dashboard-link">
                                    
                                    <span id="nameDisplay">
                                        <input type="text" id="userID" value="<%= userDetails._id %>" hidden>
                                        <span style="font-size: xx-large; font-weight: 700;">
                                            <%= userDetails.name %>
                                        </span>
                                        <i class="fas fa-edit edit-icon" onclick="toggleEditMode(nameInput)"></i>
                                    </span>
                                    <div id="nameInput" style="display: none;">
                                        <input type="text" id="nameEdit" value="<%= userDetails.name %>" />
                                        <button onclick="submitEdit('nameEdit', 'nameDisplay', nameInput)">Save</button>
                                    </div>

                                        <p class="lead">
                                            <strong>Email:</strong>
                                            <%= userDetails.email %> <br>
                                                <strong>Phone:</strong>
                                                <span id="userPhone">
                                                    <%= userDetails.phone %>
                                                        <!-- <i class="fas fa-edit edit-icon" onclick="toggleEditMode(phoneInput)"></i> -->
                                                </span>
                                        </p>
                                        <div id="phoneInput" style="display: none;">
                                            <input type="text" id="phoneEdit" value="<%= userDetails.phone %>" />
                                            <button onclick="submitEdit('phoneEdit', 'userPhone', phoneInput)">Save</button>
                                        </div>
                                    
                                    </div>




                                    <div class="tab-pane fade" id="tab-orders" role="tabpanel"
                                        aria-labelledby="tab-orders-link">



                                    <div class="container-fluid">
                                        <h2 class="title mb-3">Orders List</h2>
                                    
                                        <% if (AllOrders.length===0) { %>
                                            <p>You have not ordered anything yet.</p>
                                            <% } else { %>
                                                <ul class="list-group">
                                                    <% AllOrders.forEach(order=> { %>
                                                        <li class="list-group-item mb-3" onclick="window.location='/order-details?orderID=<%= order._id %>'"
                                                            style="cursor: pointer; border: 1px solid #dee2e6; border-radius: 2rem;">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div class="text-right">
                                                                    <p class="mb-0">
                                                                        <strong>Product Names:</strong>
                                                                        <%= order.products.map(productInfo=>
                                                                            productInfo.product.pname).join(', ') %>
                                                                    </p>
                                                                </div>
                                                                <div>
                                                                    <a href="/order-details?orderID=<%= order._id %>" class="text-decoration-none">
                                                                        <strong>Order ID:</strong>
                                                                        <%= order._id %>
                                                                    </a>
                                                                    <p class="mb-1">
                                                                        <strong>Status:</strong>
                                                                        <span class="badge badge-primary">
                                                                            <%= order.status %>
                                                                        </span>
                                                                    </p>
                                                                    <p class="mb-0">
                                                                        <strong>Order Date:</strong>
                                                                        <%= new Date(order.orderDate).toLocaleDateString() %>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </li>
                                                        <% }); %>
                                                </ul>
                                                <% } %>
                                    </div>



                                    </div><!-- .End .tab-pane -->

                                    <div class="tab-pane fade" id="tab-downloads" role="tabpanel"
                                        aria-labelledby="tab-downloads-link">
                                        <p>No downloads available yet.</p>
                                        <a href="category.html" class="btn btn-outline-primary-2"><span>GO SHOP</span><i
                                                class="icon-long-arrow-right"></i></a>
                                    </div><!-- .End .tab-pane -->

                                    <div class="tab-pane fade" id="tab-address" role="tabpanel"
                                        aria-labelledby="tab-address-link">
                                        <p>The following addresses will be used on the checkout page by default.</p>

                                        <%if(pageinfo==="AddressSize"){%>
                                            <p style="color: red;">Error: Cannot add more than 4 addresses.</p>
                                            <script>
                                                document.addEventListener("DOMContentLoaded", function () {

                                                    var tabAddressLink = document.getElementById("tab-address-link");
                                                    tabAddressLink.click();
                                                });
                                            </script>

                                            <%}%>

                                                <div class="row">


                                                    <% if (matchingAddress && matchingAddress.address) { %>
                                                        <% for (const address of matchingAddress.address) { %>
                                                            <div class="col-lg-6">
                                                                <div class="card card-dashboard">
                                                                    <div class="card-body">
                                                                        <button
                                                                            style="height: 5px; width: 5px; font-size: xx-small;"
                                                                            onclick="deleteAddress('<%= address._id %>')"
                                                                            class="btn btn-outline-danger float-right">Delete</button>
                                                                        <h3 class="card-title">
                                                                            <%= address.type %> Address <br>

                                                                        </h3>
                                                                        <p>

                                                                            <%= address.AddName %><br>
                                                                                <%= address.House %><br>
                                                                                    <%= address.street %><br>
                                                                                        <%= address.city %><br>
                                                                                            <%= address.state %><br>
                                                                                                <%= address.PIN %> <br>
                                                                                                    <a
                                                                                                        href="/edit-address<%= address._id %>">Edit
                                                                                                        <i
                                                                                                            class="icon-edit"></i></a>
                                                                        </p>
                                                                    </div><!-- End .card-body -->
                                                                </div>
                                                            </div>
                                                            <% } %>
                                                                <% } %>








                                                                    <div class="col-lg-6">
                                                                        <div class="card card-dashboard">
                                                                            <div class="card-body">
                                                                                <h3 class="card-title">Add Address</h3>
                                                                                <p>
                                                                                    <a href="/add-address">Add <i
                                                                                            class="icon-plus"></i></a>
                                                                                </p>
                                                                            </div><!-- End .card-body -->
                                                                        </div><!-- End .card-dashboard -->
                                                                    </div><!-- End .col-lg-6 -->
                                                </div><!-- End .row -->
                                    </div><!-- .End .tab-pane -->
                                    <div class="tab-pane fade" id="tab-account" role="tabpanel"
                                        aria-labelledby="tab-account-link">

                                        <form id="changePasswordForm" method="post">
                                            <p id="errorMessage" style="color: red;"></p>
                                            <div class="row">

                                                <input type="text" class="form-control" value="<%=userDetails._id%>"
                                                    hidden name="userID">
                                                <div class="col-sm-5">
                                                    <label>Old Password *</label>
                                                    <input type="password" class="form-control" name="oldPassword"
                                                        required maxlength="20">
                                                </div><!-- End .col-sm-12 -->
                                            </div><!-- End .row -->

                                            <div class="row">
                                                <div class="col-sm-5">
                                                    <label>New Password *</label>
                                                    <input type="password" class="form-control" name="newPassword"
                                                        required maxlength="20" pattern="(?=.*\d)(?=.*[A-Z]).{8,}"
                                                        title="Password must contain at least one digit and one uppercase letter, and be at least 8 characters long">
                                                    <small class="form-text text-muted">
                                                        Password must contain at least one digit and one uppercase
                                                        letter, and be at least 8 characters
                                                        long.
                                                    </small>
                                                </div><!-- End .col-sm-5 -->
                                            </div><!-- End .row -->

                                            <div class="row">
                                                <div class="col-sm-5">
                                                    <label>Confirm New Password *</label>
                                                    <input type="password" class="form-control"
                                                        name="confirmNewPassword" required maxlength="20"
                                                        pattern="(?=.*\d)(?=.*[A-Z]).{8,}"
                                                        title="Password must contain at least one digit and one uppercase letter, and be at least 8 characters long">
                                                </div><!-- End .col-sm-5 -->
                                            </div><!-- End .row -->
                                            <button type="submit" class="btn btn-primary mt-3">Change Password</button>
                                        </form>
                                    </div>
                                </div>

                                <%if(pageinfo==="Address"){%>
                                    <script>
                                        document.addEventListener("DOMContentLoaded", function () {

                                            var tabAddressLink = document.getElementById("tab-address-link");
                                            tabAddressLink.click();
                                        });
                                    </script>
                                    <%}%>


                                        <%if(pageinfo==="orders"){%>
                                            <script>
                                                document.addEventListener("DOMContentLoaded", function () {

                                                    var tabAddressLink = document.getElementById("tab-orders-link");
                                                    tabAddressLink.click();
                                                });
                                            </script>
                                            <%}%>
                                           

        </main>
        <footer class="footer footer-2">
            <div class="footer-middle">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-12 col-lg-4">
                            <div class="widget widget-about">
                                <img src="assets/images/LogoFooter.png" class="footer-logo" alt="Footer Logo"
                                    width="280" height="25">
                                <p>Praesent dapibus, neque id cursus ucibus, tortor neque egestas augue, eu vulputate
                                    magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan
                                    porttitor, facilisis luctus, metus. </p>

                                <div class="widget-about-info">
                                    <div class="row">


                                    </div><!-- End .row -->
                                </div><!-- End .widget-about-info -->
                            </div><!-- End .widget about-widget -->
                        </div><!-- End .col-sm-12 col-lg-4 -->

                        <div class="col-sm-4 col-lg-2">
                            <div class="widget">
                                <h4 class="widget-title">Information</h4><!-- End .widget-title -->

                                <ul class="widget-list">
                                    <li><a href="about.html">About Molla</a></li>
                                    <li><a href="#">How to shop on Molla</a></li>
                                    <li><a href="faq.html">FAQ</a></li>
                                    <li><a href="contact.html">Contact us</a></li>
                                    <li><a href="login.html">Log in</a></li>
                                </ul><!-- End .widget-list -->
                            </div><!-- End .widget -->
                        </div><!-- End .col-sm-4 col-lg-2 -->

                        <div class="col-sm-4 col-lg-2">
                            <div class="widget">
                                <h4 class="widget-title">Customer Service</h4><!-- End .widget-title -->

                                <ul class="widget-list">
                                    <li><a href="#">Payment Methods</a></li>
                                    <li><a href="#">Money-back guarantee!</a></li>
                                    <li><a href="#">Returns</a></li>
                                    <li><a href="#">Shipping</a></li>
                                    <li><a href="#">Terms and conditions</a></li>
                                    <li><a href="#">Privacy Policy</a></li>
                                </ul><!-- End .widget-list -->
                            </div><!-- End .widget -->
                        </div><!-- End .col-sm-4 col-lg-2 -->

                        <div class="col-sm-4 col-lg-2">
                            <div class="widget">
                                <h4 class="widget-title">My Account</h4><!-- End .widget-title -->

                                <ul class="widget-list">
                                    <li><a href="#">Sign In</a></li>
                                    <li><a href="">View Cart</a></li>
                                    <li><a href="#">My Wishlist</a></li>
                                    <li><a href="#">Track My Order</a></li>
                                    <li><a href="#">Help</a></li>
                                </ul><!-- End .widget-list -->
                            </div><!-- End .widget -->
                        </div><!-- End .col-sm-4 col-lg-2 -->

                        <div class="col-sm-6 col-lg-2">
                            <div class="widget widget-newsletter">
                                <h4 class="widget-title">Newsletter</h4><!-- End .widget-title -->

                                <p>Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan.</p>

                                <form action="#">
                                    <div class="input-group">
                                        <input type="email" class="form-control" placeholder="Enter your Email Address"
                                            aria-label="Email Adress" required>
                                        <div class="input-group-append">
                                            <button class="btn btn-dark" type="submit"><i
                                                    class="icon-long-arrow-right"></i></button>
                                        </div><!-- .End .input-group-append -->
                                    </div><!-- .End .input-group -->
                                </form>
                            </div><!-- End .widget -->
                        </div><!-- End .col-sm-6 col-lg-2 -->
                    </div><!-- End .row -->
                </div><!-- End .container-fluid -->
            </div><!-- End .footer-middle -->

            <div class="footer-bottom">
                <div class="container-fluid">
                    <p class="footer-copyright">Copyright © 2019 Molla Store. All Rights Reserved.</p>
                    <!-- End .footer-copyright -->
                    <ul class="footer-menu">
                        <li><a href="#">Terms Of Use</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                    </ul><!-- End .footer-menu -->

                    <div class="social-icons social-icons-color">
                        <span class="social-label">Socials</span>
                        <a href="#" class="social-icon social-facebook" title="Facebook" target="_blank"><i
                                class="icon-facebook-f"></i></a>
                        <a href="#" class="social-icon social-twitter" title="Twitter" target="_blank"><i
                                class="icon-twitter"></i></a>
                        <a href="#" class="social-icon social-instagram" title="Instagram" target="_blank"><i
                                class="icon-instagram"></i></a>
                        <a href="#" class="social-icon social-youtube" title="Youtube" target="_blank"><i
                                class="icon-youtube"></i></a>
                        <a href="#" class="social-icon social-pinterest" title="Pinterest" target="_blank"><i
                                class="icon-pinterest"></i></a>
                    </div><!-- End .soial-icons -->
                </div><!-- End .container-fluid -->
            </div><!-- End .footer-bottom -->
        </footer><!-- End .footer -->

       
    </div><!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

    <!-- Mobile Menu -->

    <!-- Plugins JS File -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/jquery.hoverIntent.min.js"></script>
    <script src="assets/js/jquery.waypoints.min.js"></script>
    <script src="assets/js/superfish.min.js"></script>
    <script src="assets/js/owl.carousel.min.js"></script>
    <script src="assets/js/wNumb.js"></script>
    <script src="assets/js/bootstrap-input-spinner.js"></script>
    <script src="assets/js/jquery.magnific-popup.min.js"></script>
    <script src="assets/js/nouislider.min.js"></script>
    <!-- Main JS File -->
    <script src="assets/js/main.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

        window.onload = function () {
            window.scroll(0, window.innerHeight / 4.5);
        };
    </script>




    <script>

        function deleteAddress(addressId) {
            Swal.fire({
                title: 'Are you sure?',
                text: 'You won\'t be able to revert this!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!',
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/add-delete?addressId=${addressId}`, {
                        method: 'GET',
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log(data.message);
                            Swal.fire('Deleted!', 'Your address has been deleted.', 'success').then(() => {

                                window.location.href = "/profile?selected=Address";
                            });
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire('Error!', 'Failed to delete the address.', 'error');
                        });
                }
            });
        }


    </script>


   <script>
    document.getElementById('changePasswordForm').addEventListener('submit', function (event) {
        event.preventDefault(); 
        const formData = new FormData(event.target);

        const jsonData = {};
        formData.forEach((value, key) => {
            jsonData[key] = value;
        });

        fetch('/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(jsonData),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Password changed successfully');
                    Swal.fire({
                        icon: 'success',
                        title: 'Password Changed',
                        text: 'Your password has been changed successfully!',
                    }).then(() => {
                        window.location.href = '/profile?selected=Address';
                    });
                } else {
                    console.error('Error:', data.errorMessage);

                   
                    if (data.errorMessage.includes("different from the old password")) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'New password must be different from the old password.',
                        });
                    } else {
                        document.getElementById('errorMessage').innerText = data.errorMessage;
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });
</script>

<script>
    async function submitEdit(inputId, displayId, inputContainerElement) {
        const inputValue = document.getElementById(inputId).value;
        const userID = document.getElementById('userID').value;
        const phoneNO=document.getElementById('phoneEdit').value
        const displayElement = document.getElementById(displayId);

        console.log("name >>" + inputValue);
        console.log("phone no >>" + phoneNO);

        displayElement.textContent = inputValue;
        inputContainerElement.style.display = 'none';

        try {
            const response = await fetch('/edit-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: inputValue,
                    userID: userID,
                    phone: phoneNO
                })
            });

            if (!response.ok) {
                throw new Error('Failed to update profile');
            }
           location.reload()
            console.log('Profile updated successfully');

        } catch (err) {
            console.error(err);
            alert('Failed to update profile');
        }
    }

    function toggleEditMode(inputContainerElement) {
        inputContainerElement.style.display = 'block';
    }
</script>

</body>

</html>